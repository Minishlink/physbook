<?php

namespace PJM\AppBundle\Entity;

use Doctrine\ORM\EntityRepository;
use PJM\UserBundle\Entity\User;

/**
 * TransactionRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class TransactionRepository extends EntityRepository
{
    public function findByBoquetteSlugAndValid($boquette_slug, $valid = "OK")
    {
        $status = $valid ? "OK" : "NOK";
        $query = $this->createQueryBuilder('t')
                    ->where('t.status = :status')
                    ->join('t.boquette', 'b', 'WITH', 'b.slug = :boquette_slug')
                    ->setParameters(array(
                        'boquette_slug'  => $boquette_slug,
                        'status' => $status
                    ))
                    ->orderBy('t.date', 'desc')
                    ->getQuery();

        try {
            $res = $query->getResult();
        } catch (\Doctrine\Orm\NoResultException $e) {
            $res = null;
        }

        return $res;
    }
}
